name: Validate score key hash

# Allow the workflow to write to the repository
permissions:
  contents: write

on:
  push:
    branches: ["main", "master"]
  pull_request:
  workflow_dispatch:

jobs:
  validate-hash:
    name: Ensure SCORE_KEY hash matches index payload
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - name: Install ripgrep (rg) for verification
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Fail if SCORE_KEY secret is not available
        env:
          SCORE_KEY: ${{ secrets.SCORE_KEY }}
        run: |
          if [ -z "${SCORE_KEY}" ]; then
            echo "SCORE_KEY secret is not configured."
            exit 1
          fi

      - name: Compute SCORE_KEY hash
        id: hash
        env:
          SCORE_KEY: ${{ secrets.SCORE_KEY }}
        run: |
          HASH=$(printf '%s' "${SCORE_KEY}" | sha256sum | cut -d' ' -f1)
          echo "hash=${HASH}" >> "$GITHUB_OUTPUT"

      - name: Inject hash into index.html
        env:
          SCORE_KEY_HASH: ${{ steps.hash.outputs.hash }}
        run: |
          # Only run sed if the placeholder exists
          if grep -q "__SCORE_KEY_HASH__" index.html; then
            echo "Placeholder found. Injecting hash..."
            sed -i "s@__SCORE_KEY_HASH__@${SCORE_KEY_HASH}@g" index.html
          else
            echo "WARNING: Placeholder __SCORE_KEY_HASH__ not found in index.html. No changes made."
          fi

      - name: Commit index.html changes and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Build: Inject SCORE_KEY hash"
          branch: ${{ github.ref_name }}
          file_pattern: 'index.html'
          # REMOVED: skip_dirty_check: true (This was causing the crash)
          
      - name: Verify hashed secret in index.html
        env:
          EXPECTED_HASH: ${{ steps.hash.outputs.hash }}
          SCORE_KEY: ${{ secrets.SCORE_KEY }}
        run: |
          # 1. Check if the attribute exists
          if ! grep -q 'data-score-hash' index.html; then
            echo "Error: data-score-hash attribute not found in index.html"
            exit 1
          fi

          # 2. Check if the hash matches the secret
          ACTUAL_HASH=$(grep -oP 'data-score-hash="\K[^\"]+' index.html)
          
          # If the placeholder is still there (injection failed), fail the build
          if [ "${ACTUAL_HASH}" == "__SCORE_KEY_HASH__" ]; then
             echo "Error: The placeholder was not replaced. Ensure index.html has __SCORE_KEY_HASH__ before running."
             exit 1
          fi

          if [ "${ACTUAL_HASH}" != "${EXPECTED_HASH}" ]; then
            echo "Error: Hash mismatch."
            echo "Expected: ${EXPECTED_HASH}"
            echo "Found:    ${ACTUAL_HASH}"
            exit 1
          fi

          # 3. Security checks
          if rg --quiet --fixed-strings "${SCORE_KEY}" game.js; then
            echo "Error: Hardcoded secret detected in game.js"
            exit 1
          fi

          echo "Success: Index file hash matches SCORE_KEY secret."
